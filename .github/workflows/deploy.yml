name: Cloudflare Workers CI/CD

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_target:
        description: "Build target to override change detection"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - api
          - pipeline
          - both
      deploy_env:
        description: "Deploy environment for manual runs"
        required: false
        default: "none"
        type: choice
        options:
          - none
          - preview
          - production

jobs:
  detect-changes:
    name: Detect Worker Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    outputs:
      api: ${{ steps.api.outputs.changed }}
      pipeline: ${{ steps.pipeline.outputs.changed }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect API Worker Changes
        id: api
        run: |
          BT="${{ github.event.inputs.build_target }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          SHA="${{ github.sha }}"

          # Force rebuild if manually requested
          if [ "$BT" = "api" ] || [ "$BT" = "both" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "reason=manual_override" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for force rebuild markers in commit messages or PR
          MSG="${{ github.event.head_commit.message }}"
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          if echo "$MSG $TITLE $BODY" | grep -Ei '\[(full|rebuild)( api)?\]'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "reason=force_rebuild_marker" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine comparison base
          if [ "$CURRENT_BRANCH" = "main" ]; then
            # On main: compare against last successful deployment
            # Get the last successful workflow run for main branch
            LAST_SUCCESS=$(gh run list --branch main --workflow "Cloudflare Workers CI/CD" --status success --limit 1 --json headSha --jq '.[0].headSha' 2>/dev/null || echo "")
            if [ -n "$LAST_SUCCESS" ] && [ "$LAST_SUCCESS" != "null" ] && [ "$LAST_SUCCESS" != "$SHA" ]; then
              COMPARE_BASE="$LAST_SUCCESS"
              echo "reason=main_vs_last_success" >> $GITHUB_OUTPUT
            else
              # Fallback: compare against previous commit
              COMPARE_BASE="HEAD^"
              echo "reason=main_vs_previous" >> $GITHUB_OUTPUT
            fi
          else
            # On branch: compare against main to get full change set
            COMPARE_BASE="origin/main"
            echo "reason=branch_vs_main" >> $GITHUB_OUTPUT
          fi

          # Check if API worker files changed
          if git diff --name-only "$COMPARE_BASE" "$SHA" 2>/dev/null | grep -q '^workers/api/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect Pipeline Worker Changes
        id: pipeline
        run: |
          BT="${{ github.event.inputs.build_target }}"
          CURRENT_BRANCH="${{ github.ref_name }}"
          SHA="${{ github.sha }}"

          # Force rebuild if manually requested
          if [ "$BT" = "pipeline" ] || [ "$BT" = "both" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "reason=manual_override" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check for force rebuild markers in commit messages or PR
          MSG="${{ github.event.head_commit.message }}"
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          if echo "$MSG $TITLE $BODY" | grep -Ei '\[(full|rebuild)( pipeline)?\]'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "reason=force_rebuild_marker" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine comparison base
          if [ "$CURRENT_BRANCH" = "main" ]; then
            # On main: compare against last successful deployment
            # Get the last successful workflow run for main branch
            LAST_SUCCESS=$(gh run list --branch main --workflow "Cloudflare Workers CI/CD" --status success --limit 1 --json headSha --jq '.[0].headSha' 2>/dev/null || echo "")
            if [ -n "$LAST_SUCCESS" ] && [ "$LAST_SUCCESS" != "null" ] && [ "$LAST_SUCCESS" != "$SHA" ]; then
              COMPARE_BASE="$LAST_SUCCESS"
              echo "reason=main_vs_last_success" >> $GITHUB_OUTPUT
            else
              # Fallback: compare against previous commit
              COMPARE_BASE="HEAD^"
              echo "reason=main_vs_previous" >> $GITHUB_OUTPUT
            fi
          else
            # On branch: compare against main to get full change set
            COMPARE_BASE="origin/main"
            echo "reason=branch_vs_main" >> $GITHUB_OUTPUT
          fi

          # Check if Pipeline worker files changed
          if git diff --name-only "$COMPARE_BASE" "$SHA" 2>/dev/null | grep -q '^workers/link-pipeline/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  test-api:
    name: Test Rust API Worker
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            workers/api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('workers/api/Cargo.lock') }}

      - name: Check formatting
        run: cd workers/api && cargo fmt -- --check

      - name: Run Clippy (fail on warnings)
        run: cd workers/api && cargo clippy -- -D warnings

      - name: Run tests
        run: cd workers/api && cargo test --verbose

      - name: Upload API build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-target
          path: workers/api/target

  test-pipeline:
    name: Test Link Pipeline Worker
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.pipeline == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('workers/link-pipeline/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Update npm to latest version
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci
        working-directory: workers/link-pipeline

      - name: Type check
        run: npm run type-check
        working-directory: workers/link-pipeline

      - name: Build
        run: npm run build
        working-directory: workers/link-pipeline

      - name: Upload Pipeline build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-dist
          path: workers/link-pipeline/dist

  deploy-api-preview:
    name: Deploy API Worker Preview
    runs-on: ubuntu-latest
    needs: [detect-changes, test-api]
    if: (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'preview')) && needs.detect-changes.outputs.api == 'true'
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            workers/api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('workers/api/Cargo.lock') }}

      - name: Download API build artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-target
          path: workers/api/target

      - name: Install worker-build if needed
        run: which worker-build || cargo install -q worker-build

      - name: Compute preview names
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PREVIEW_ID=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          else
            echo "PREVIEW_ID=manual-${{ github.run_number }}" >> $GITHUB_ENV
          fi
          echo "PIPELINE_WORKER_NAME=hamrah-link-pipeline-${PREVIEW_ID}" >> $GITHUB_ENV
          echo "API_WORKER_NAME=hamrah-api-${PREVIEW_ID}" >> $GITHUB_ENV

      - name: Prepare dynamic preview config
        run: |
          cp wrangler.preview.toml wrangler.preview.dynamic.toml
          sed -i.bak "s/service = \"hamrah-link-pipeline-preview\"/service = \"${PIPELINE_WORKER_NAME}\"/" wrangler.preview.dynamic.toml
        working-directory: workers/api

      - name: Deploy API Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --name ${{ env.API_WORKER_NAME }} --config wrangler.preview.dynamic.toml
          workingDirectory: workers/api

  deploy-pipeline-preview:
    name: Deploy Pipeline Worker Preview
    runs-on: ubuntu-latest
    needs: [detect-changes, test-pipeline]
    if: (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'preview')) && needs.detect-changes.outputs.pipeline == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('workers/link-pipeline/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Update npm to latest version
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci
        working-directory: workers/link-pipeline

      - name: Download Pipeline build artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: pipeline-dist
          path: workers/link-pipeline/dist

      - name: Build dist if artifact missing
        run: |
          if [ ! -d "dist" ]; then
            npm run build
          fi
        working-directory: workers/link-pipeline

      - name: Compute preview names
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PREVIEW_ID=pr-${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          else
            echo "PREVIEW_ID=manual-${{ github.run_number }}" >> $GITHUB_ENV
          fi
          echo "PIPELINE_WORKER_NAME=hamrah-link-pipeline-${PREVIEW_ID}" >> $GITHUB_ENV
          echo "API_WORKER_NAME=hamrah-api-${PREVIEW_ID}" >> $GITHUB_ENV

      - name: Deploy Pipeline Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --name ${{ env.PIPELINE_WORKER_NAME }}
          workingDirectory: workers/link-pipeline

  deploy-api-production:
    name: Deploy API Worker Production
    runs-on: ubuntu-latest
    needs: [detect-changes, test-api]
    if: ((github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'production')) && needs.detect-changes.outputs.api == 'true'
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            workers/api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('workers/api/Cargo.lock') }}

      - name: Download API build artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-target
          path: workers/api/target

      - name: Install worker-build if needed
        run: which worker-build || cargo install -q worker-build

      - name: Deploy API Production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: workers/api

  deploy-pipeline-production:
    name: Deploy Pipeline Worker Production
    runs-on: ubuntu-latest
    needs: [detect-changes, test-pipeline]
    if: ((github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'production')) && needs.detect-changes.outputs.pipeline == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('workers/link-pipeline/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Update npm to latest version
        run: npm install -g npm@latest

      - name: Install dependencies
        run: npm ci
        working-directory: workers/link-pipeline

      - name: Download Pipeline build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pipeline-dist
          path: workers/link-pipeline/dist

      - name: Deploy Pipeline Production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: workers/link-pipeline
