name: Cloudflare Workers CI/CD

"on":
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      build_target:
        description: "Build target to override change detection"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - api
          - pipeline
          - both
      deploy_env:
        description: "Deploy environment for manual runs"
        required: false
        default: "none"
        type: choice
        options:
          - none
          - preview
          - production

jobs:
  detect-changes:
    name: Detect Worker Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.api.outputs.changed }}
      pipeline: ${{ steps.pipeline.outputs.changed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect API Worker Changes
        id: api
        run: |
          BT="${{ github.event.inputs.build_target }}"
          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"
          # Fallback for manual dispatch where 'before' may be empty
          if [ -z "$BEFORE" ]; then
            BEFORE="$(git rev-parse HEAD^ 2>/dev/null || echo "")"
            SHA="$(git rev-parse HEAD 2>/dev/null || echo "")"
          fi

          if [ "$BT" = "api" ] || [ "$BT" = "both" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          elif [ -n "$BEFORE" ] && [ -n "$SHA" ] && git diff --name-only "$BEFORE" "$SHA" | grep -q '^workers/api/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            MSG="${{ github.event.head_commit.message }}"
            TITLE="${{ github.event.pull_request.title }}"
            BODY="${{ github.event.pull_request.body }}"
            if echo "$MSG $TITLE $BODY" | grep -Ei '\[(full|rebuild)( api)?\]'; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Detect Pipeline Worker Changes
        id: pipeline
        run: |
          BT="${{ github.event.inputs.build_target }}"
          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"
          # Fallback for manual dispatch where 'before' may be empty
          if [ -z "$BEFORE" ]; then
            BEFORE="$(git rev-parse HEAD^ 2>/dev/null || echo "")"
            SHA="$(git rev-parse HEAD 2>/dev/null || echo "")"
          fi

          if [ "$BT" = "pipeline" ] || [ "$BT" = "both" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          elif [ -n "$BEFORE" ] && [ -n "$SHA" ] && git diff --name-only "$BEFORE" "$SHA" | grep -q '^workers/link-pipeline/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            MSG="${{ github.event.head_commit.message }}"
            TITLE="${{ github.event.pull_request.title }}"
            BODY="${{ github.event.pull_request.body }}"
            if echo "$MSG $TITLE $BODY" | grep -Ei '\[(full|rebuild)( pipeline)?\]'; then
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

  test-api:
    name: Test Rust API Worker
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            workers/api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('workers/api/Cargo.lock') }}

      - name: Check formatting
        run: cd workers/api && cargo fmt -- --check

      - name: Run Clippy (fail on warnings)
        run: cd workers/api && cargo clippy -- -D warnings

      - name: Run tests
        run: cd workers/api && cargo test --verbose

      - name: Upload API build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-target
          path: workers/api/target

  test-pipeline:
    name: Test Link Pipeline Worker
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.pipeline == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure npm cache directory exists
        run: mkdir -p ~/.npm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "workers/link-pipeline/package-lock.json"

      - name: Install dependencies
        run: npm ci
        working-directory: workers/link-pipeline

      - name: Type check
        run: npm run type-check
        working-directory: workers/link-pipeline

      - name: Build
        run: npm run build
        working-directory: workers/link-pipeline

      - name: Upload Pipeline build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-dist
          path: workers/link-pipeline/dist

  deploy-api-preview:
    name: Deploy API Worker Preview
    runs-on: ubuntu-latest
    needs: [detect-changes, test-api]
    if: (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'preview')) && needs.detect-changes.outputs.api == 'true'
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            workers/api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('workers/api/Cargo.lock') }}

      - name: Download API build artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-target
          path: workers/api/target

      - name: Install worker-build if needed
        run: which worker-build || cargo install -q worker-build

      - name: Deploy API Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --config wrangler.preview.toml
          workingDirectory: workers/api

  deploy-pipeline-preview:
    name: Deploy Pipeline Worker Preview
    runs-on: ubuntu-latest
    needs: [detect-changes, test-pipeline]
    if: (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'preview')) && needs.detect-changes.outputs.pipeline == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure npm cache directory exists
        run: mkdir -p ~/.npm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "workers/link-pipeline/package-lock.json"

      - name: Install dependencies
        run: npm ci
        working-directory: workers/link-pipeline

      - name: Download Pipeline build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pipeline-dist
          path: workers/link-pipeline/dist

      - name: Deploy Pipeline Preview
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy --env preview
          workingDirectory: workers/link-pipeline

  deploy-api-production:
    name: Deploy API Worker Production
    runs-on: ubuntu-latest
    needs: [detect-changes, test-api]
    if: ((github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'production')) && needs.detect-changes.outputs.api == 'true'
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust Toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            workers/api/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('workers/api/Cargo.lock') }}

      - name: Download API build artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-target
          path: workers/api/target

      - name: Install worker-build if needed
        run: which worker-build || cargo install -q worker-build

      - name: Deploy API Production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: workers/api

  deploy-pipeline-production:
    name: Deploy Pipeline Worker Production
    runs-on: ubuntu-latest
    needs: [detect-changes, test-pipeline]
    if: ((github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy_env == 'production')) && needs.detect-changes.outputs.pipeline == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Ensure npm cache directory exists
        run: mkdir -p ~/.npm

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "workers/link-pipeline/package-lock.json"

      - name: Install dependencies
        run: npm ci
        working-directory: workers/link-pipeline

      - name: Download Pipeline build artifacts
        uses: actions/download-artifact@v4
        with:
          name: pipeline-dist
          path: workers/link-pipeline/dist

      - name: Deploy Pipeline Production
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: deploy
          workingDirectory: workers/link-pipeline
